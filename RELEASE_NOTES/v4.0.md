## üöÄ What's New in v4.0

This release evolves Burn2Cool from a feature-rich v3.0 into a more robust runtime-controlled thermal management daemon with enhanced thermal zone detection, average temperature support, improved web UI, and comprehensive skin management.

### ‚ú® Major New Features

#### Automatic Thermal Zone Detection
- Added `detect_cpu_thermal_zone()` for auto-detecting the best CPU thermal zone by scanning `/sys/class/thermal` and type strings
- Added CLI flag `--thermal-zone` and config key `thermal_zone` to override auto selection
- Priority order: explicit `--sensor` path ‚Üí `--thermal-zone` ‚Üí auto-detect

#### Average CPU Temperature Support
- New CLI flag `--avg-temp` and config key `avg_temp` to use the average temperature across CPU-related thermal zones
- Implemented `read_avg_cpu_temp()` to compute averages across zones that are CPU-related (type strings: cpu/core/x86/intel/amd/pkg etc.)

#### Web UI Refresh & Responsive Improvements
- Reworked `assets/index.html`, `assets/main.js`, and `assets/styles.css` with card-based layout, improved mobile/viewport handling, and clearer UI for thermal info
- Added `status` fields for `thermal_zone` and `use_avg_temp` and improved the Profiles/Settings UI

#### System Skins Support
- Support for system-wide skin directories (`/usr/local/share/burn2cool/skins`)
- Skin activation via installer (`--install-skin`)
- Runtime skin selection and extra JS injection
- New web UI for skin management: install, remove, preview, and activate skins
- Upload progress support with client-side progress bar
- Server-side `/api/skins/*` endpoints: listing, activate, deactivate, upload, default, and remove

### üîß Improvements

#### Throttling Algorithm Enhancements
- Linear scaling and hysteresis for smoother frequency transitions
- Hysteresis threshold (default 3¬∞C) prevents frequent oscillation
- Behavior bounded by `safe_min` where configured

#### Runtime Controls & Configuration
- Normalization for `excluded_types` inputs: trim whitespace, lowercase tokens, dedupe across all endpoints
- Web UI settings saves return `saved` and `saved_to` metadata
- Added `excluded_types` config & UI for excluding thermal zone types from averaging
- Enhanced JSON API with new endpoints and fields

#### CLI & Control Socket Improvements
- `cpu_throttle_ctl` accepts `--json`/`-j` and `--pretty`/`-p` flags on listing commands
- New CLI commands: `get-profile`/`put-profile`, `start`, `restart`
- Socket commands accept `json` suffix for JSON output
- Added `get-excluded-types` socket command
- Networking robustness: SIGPIPE handling, send_all helper, whitespace trimming

#### GUI Tray Optimizations
- **Resource Efficiency**: Tray components now prefer Unix socket communication over HTTP for reduced overhead
- **Consistent Communication**: Unified socket-first behavior across main tray and overview window
- **Build Quality**: Eliminated compiler warnings for clean `-Wall` builds

#### HTTP/REST API Enhancements
- `POST /api/skins/upload` accepts `activate` as boolean or string
- Skin upload supports tar.gz, tar, and zip archives
- Secure temporary file handling with mkstemp
- Archive extraction strips single top-level directories to avoid nesting

### üêõ Bug Fixes

- Fixed thermal zone selection and invalid temperature readings
- Avoided excessive UI button heights on narrow screens
- Fixed parsing & range issues in config and CLI handling
- Fixed skin upload/extract path issues causing double-nesting
- TUI excluded state toggling now merges with server-side values
- CLI `get-excluded-types` returns current CSV for safe merges
- Fixed edge cases with mkstemp and large base64 payloads
- **Build Quality**: Resolved compiler warnings in GUI tray code for clean builds

### üîí Security & Stability Improvements

- **Command Injection Prevention:** Replaced unsafe `system()` calls with secure `fork()`/`execvp()` pattern
- **Buffer Overflow Protection:** Replaced unsafe string operations with bounds-checked `snprintf()`
- **Enhanced Input Validation:** Comprehensive bounds checking for config values and CLI arguments
- **Improved Error Handling:** Strengthened error handling with proper cleanup
- **Log Rotation:** Automatic log file rotation (10MB limit)
- **Performance Optimization:** CPU frequency path caching
- **Unit Testing:** Added `--test` CLI option with basic unit tests
- **API Extensions:** Added `/api/metrics` endpoint for real-time CPU frequency data

### üß≠ Developer / Packaging

- Regenerated embedded asset headers
- Updated `cpu_throttle_ctl` to sync with server API changes
- Updated packaging artifacts

### üîÑ Migration Guide

This section provides guidance for users upgrading from v3.0 to v4.0. The upgrade is generally backward compatible, but there are new configuration options that can enhance thermal management.

#### New Configuration Options

v4.0 introduces several new configuration keys that can be set in `/etc/cpu_throttle.conf`:

- **`thermal_zone`** (optional): Manually specify which thermal zone to monitor instead of auto-detection
  - Format: Integer (e.g., `thermal_zone = 0`)
  - Default: Auto-detection if not specified
  - Use `cpu_throttle_ctl list-zones` to see available zones

- **`avg_temp`** (optional): Use average temperature across all CPU-related thermal zones instead of a single zone
  - Format: Boolean (`true`/`false`)
  - Default: `false` (uses single zone)
  - Useful for systems with multiple CPU thermal sensors

- **`excluded_types`** (optional): Exclude specific thermal zone types from averaging when `avg_temp = true`
  - Format: Comma-separated list (e.g., `excluded_types = wifi,int3400`)
  - Default: Empty (no exclusions)
  - Common exclusions: `wifi`, `int3400`, `sen3`, etc.

#### Example Configuration

```ini
# Manual thermal zone selection (overrides auto-detection)
thermal_zone = 2

# Use average temperature across CPU zones
avg_temp = true

# Exclude non-CPU thermal zones from averaging
excluded_types = wifi,int3400,sen3
```

#### Migration Steps

1. **Backup your current configuration** (if any):
   ```bash
   sudo cp /etc/cpu_throttle.conf /etc/cpu_throttle.conf.backup
   ```

2. **Update the daemon** using your package manager or manual installation

3. **Test thermal zone detection**:
   ```bash
   cpu_throttle_ctl list-zones
   ```
   This shows all available thermal zones with their types and current temperatures.

4. **Configure new options** (optional):
   - Edit `/etc/cpu_throttle.conf` to add the new keys as needed
   - Restart the daemon: `sudo systemctl restart cpu_throttle` (or equivalent)

5. **Verify operation**:
   ```bash
   cpu_throttle_ctl status
   ```
   Check that temperatures are being read correctly and throttling works as expected.

#### Backward Compatibility

- Existing configurations without the new keys will continue to work unchanged
- Auto-detection of thermal zones provides the same behavior as v3.0 by default
- All existing CLI commands and API endpoints remain functional

### üîú TODO / Next Steps

- ~~Normalize control socket outputs to consistent JSON structure~~ (cancelled - breaking change for v4.0)
- ~~Consider hardening extraction with `posix_spawn` or `libarchive`~~ (implemented - replaced fork+execlp with posix_spawn)

---

### üß± Daemon / CPU Handling (Detailed)

The `cpu_throttle.c` daemon contains numerous enhancements:

#### Version & Restart Handling
- `DAEMON_VERSION` updated to **4.0**
- `should_restart` flag for graceful restart flow

#### Thermal Zone Selection
- `--thermal-zone` and `thermal_zone` config for manual selection
- `detect_cpu_thermal_zone()` finds best CPU zone based on type strings and temperatures
- `set_thermal_zone_path()` sets sensor path for specified zone

#### Average Temperature
- `--avg-temp` flag uses average across CPU-related zones
- `read_avg_cpu_temp()` gathers and averages CPU zones (cpu/core/x86/intel/amd/pkg)

#### Exclusion System
- `excluded_types` config excludes zone types from averaging
- `is_excluded_thermal_type()` parses configured list with fallbacks

#### JSON API Enhancements
- `build_zones_json()` returns zones with zone, type, temp, excluded flag
- `build_status_json()` includes thermal_zone and use_avg_temp fields
- New `/api/zones`, `/api/metrics` endpoints

#### Throttling & Hysteresis
- Linear curve scales frequency from `temp_max - 30` to `temp_max`
- Hysteresis prevents oscillation with `last_throttle_temp` tracking
- Bounded by `safe_min` configuration

#### Config Persistence
- `save_config_file()` persists runtime changes to `/etc/cpu_throttle.conf`
- Stricter validation and null-termination for robustness

These updates were identified by comparing v3.0 to v4.0 beta branch.
