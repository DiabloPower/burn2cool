## üöÄ What's New in v4.0 (Draft)

This release evolves Burn2Cool from a feature-rich v3.0 into a more robust runtime-controlled thermal management daemon.

> NOTE: This is a draft changelog for v4.0. Additional changes will be added before release.

### ‚ú® Major New Features

- Automatic thermal zone detection and manual thermal zone selection
  - Added `detect_cpu_thermal_zone()` for auto-detecting the best CPU thermal zone by scanning `/sys/class/thermal` and type strings.
  - Added CLI flag `--thermal-zone` and config key `thermal_zone` to override auto selection.
  - Priority order: explicit `--sensor` path ‚Üí `--thermal-zone` ‚Üí auto-detect.

- Average CPU temperature reporting and usage
  - New CLI flag `--avg-temp` and config key `avg_temp` to use the average temperature across CPU-related thermal zones.
  - Implemented `read_avg_cpu_temp()` to compute averages across zones that are CPU-related (type strings: cpu/core/x86/intel/amd/pkg etc.).

- Web UI Refresh & responsive improvements
  - Reworked `assets/index.html`, `assets/main.js`, and `assets/styles.css` with card-based layout, improved mobile/viewport handling, and clearer UI for thermal info.
  - Added `status` fields for `thermal_zone` and `use_avg_temp` and improved the Profiles/Settings UI.

### üîß Improvements

- Throttling algorithm enhancements
  - Introduced `last_throttle_temp` and a `hysteresis` (3¬∞C) to reduce oscillation during frequent thermal changes.
  - Implemented a linear throttling curve starting at `temp_max - 30¬∞C` down to `temp_max`, scaling frequency proportionally between `max_freq` and `min_freq`.

- Runtime controls, config and JSON improvements
  - Added `excluded_types` config and UI support to exclude specific thermal zone types (e.g., INT3400) from averages.
  - `build_zones_json()` returns JSON with zones, types, `temp` (or `null` for excluded) and `excluded` flag.
  - Updated `/api/zones` and `/api/status` endpoints to include new fields.

- Robustness & edge-case handling
  - Buffered IO and `fscanf` return checks added to avoid partial reads.
  - Enforced `strncpy` safety and null termination on critical strings.
  - Added `save_config_file()` to persist the new settings to `/etc/cpu_throttle.conf`.

### üêõ Bug Fixes

- Fixed several issues around thermal zone selection and invalid temp readings.
- Avoided excessive UI button heights on narrow screens by constraining setting-row buttons in CSS.
- Fixed various parsing & range issues in config parsing and CLI handling.

### üß≠ Developer / Packaging

- Regenerated embedded asset headers (`include/index_html.h`, `include/main_js.h`, `include/styles_css.h`).
- Updated `cpu_throttle_ctl` to keep in sync with server/socket API changes.
- Updated packaging artifact `burn2cool-linux-x86_64-v3.0.tar.xz` (replaced during iterative work) ‚Äî will be re-tagged/rebuilt for v4.0.

### üîú TODO / Next Steps (for v4.0 finishing)

- Add integration tests for thermal zone detection / avg temp behavior across various systems.
- Add end-user upgrade/migration notes focusing on the `thermal_zone`, `avg_temp`, and `excluded_types` config keys.
- Iterate on UI for shorter labels / icons for smaller screens and add an icon-only control where appropriate.
- Add docs for `cpu_throttle_ctl` runtime control commands for new settings.

---

Last update (draft): Compare `origin/main (v3.0)` ‚Üí `beta (v4.x draft)` ‚Äî includes feature additions for thermal detection, avg-temp, UI updates, and throttling improvements.

If you prefer, I can open a PR from `beta` to set this as `RELEASE_NOTES/v4.0.md` and continue iterating there.
