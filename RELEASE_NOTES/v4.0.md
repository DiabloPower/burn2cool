## üöÄ What's New in v4.0 (Draft)

This release evolves Burn2Cool from a feature-rich v3.0 into a more robust runtime-controlled thermal management daemon.

> NOTE: This is a draft changelog for v4.0. Additional changes will be added before release.

### ‚ú® Major New Features

- Automatic thermal zone detection and manual thermal zone selection
  - Added `detect_cpu_thermal_zone()` for auto-detecting the best CPU thermal zone by scanning `/sys/class/thermal` and type strings.
  - Added CLI flag `--thermal-zone` and config key `thermal_zone` to override auto selection.
  - Priority order: explicit `--sensor` path ‚Üí `--thermal-zone` ‚Üí auto-detect.

- Average CPU temperature reporting and usage
  - New CLI flag `--avg-temp` and config key `avg_temp` to use the average temperature across CPU-related thermal zones.
  - Implemented `read_avg_cpu_temp()` to compute averages across zones that are CPU-related (type strings: cpu/core/x86/intel/amd/pkg etc.).

- Web UI Refresh & responsive improvements
  - Reworked `assets/index.html`, `assets/main.js`, and `assets/styles.css` with card-based layout, improved mobile/viewport handling, and clearer UI for thermal info.
  - Added `status` fields for `thermal_zone` and `use_avg_temp` and improved the Profiles/Settings UI.

### üîß Improvements (summary)

- Throttling algorithm enhancements (linear scaling and hysteresis) ‚Äî see "Daemon / CPU handling (detailed)" for specifics.
- Runtime controls, config, and JSON improvements (excluded types, zones endpoint, status fields).
  - Normalization for `excluded_types` inputs: REST and socket endpoints now trim whitespace, lowercase tokens and dedupe, for consistent behavior across clients.
  - Web UI: Settings saves now return `saved` and `saved_to` metadata in responses, and the UI displays a toast message showing where the configuration was persisted.
- Robustness & edge-case handling (safer file reads, explicit string termination, config persistence).
- System skins: add support for system-wide skin directories (`/usr/local/share/burn2cool/skins`), skin activation via installer (`--install-skin`), runtime skin selection and extra JS injection. Added control utility commands and API endpoints for skins.
  - New web UI for skin management: open the skins modal, install, remove, preview, and activate skins.
  - Added `Install` and `Remove` actions on the UI; added `Activate after install` checkbox and `Default` (house) action to revert back to embedded assets.
  - Upload progress support (client-side progress bar) while uploading skin archives.
  - Server-side `/api/skins/*` endpoints expanded: listing, activate, deactivate, upload, default, and remove endpoints for HTTP clients.
  - Server upload handler now reads POST bodies robustly, supports large base64 payloads, supports gzip tar, uncompressed tar, and zip, and writes uploaded archives to a secure temporary file (uses mkstemp)
  - On install we strip a single top-level directory in an archive (e.g., `example/‚Ä¶`) to avoid creating `id/id/...` paths when archives package their folder.
  - Reinstall semantics: uploading a skin with the same manifest id will overwrite the existing installation (no automatic versioning ‚Äî intended behavior for production/upgrade scenarios).
  - Improved logging and error reporting for installer flows, including explicit verbose/error logs to `/tmp/cpu_throttle.log` when enabled.

  ### üîß CLI & control socket improvements

  - `cpu_throttle_ctl` updates: accept `--json`/`-j` and `--pretty`/`-p` flags on listing commands (profiles, zones, limits, skins) to request and (optionally) pretty-print JSON returned by the daemon; `skins install` gained a `--activate`/`-a` flag to activate the installed skin automatically; `skins remove` accepts `--yes`/`-y` to bypass confirmation prompts.
  - `cpu_throttle_ctl` updates: accept `--json`/`-j` and `--pretty`/`-p` flags on listing commands (profiles, zones, limits, skins) to request and (optionally) pretty-print JSON returned by the daemon; `skins install` gained a `--activate`/`-a` flag to activate the installed skin automatically; `skins remove` accepts `--yes`/`-y` to bypass confirmation prompts. New CLI commands: `get-profile`/`put-profile` for raw profile retrieval and upload; `start` and `restart` commands to start/restart the daemon via systemctl or background fallback.

  - Socket command behavior: control socket commands accept a `json` suffix (e.g., `status json`, `list-skins json`) and return JSON for easier automation. Added `get-excluded-types` socket command to allow clients to query the current CSV without overwriting it (helpful for UIs and scripts); the daemon trims trailing whitespace from socket input so commands sent with trailing newlines or spaces behave correctly.

  - Networking/IPC robustness: CLI now ignores `SIGPIPE` to avoid being terminated when the daemon closes the socket unexpectedly and uses a `send_all` helper to ensure full write of arguments to the socket.
  - Network/socket robustness: CLI ignores `SIGPIPE` to prevent being killed by a closed/terminated daemon and uses a `send_all` helper to ensure full writes; server-side command parsing trims trailing whitespace/newlines so commands like `list-skins\n` and `status\n` are handled reliably.
  - HTTP/REST improvements: `POST /api/skins/upload` now accepts `activate` as a JSON boolean in addition to the string form (e.g. `true` or `"true"`).

### üêõ Bug Fixes

- Fixed several issues around thermal zone selection and invalid temp readings.
- Avoided excessive UI button heights on narrow screens by constraining setting-row buttons in CSS.
- Fixed various parsing & range issues in config parsing and CLI handling.
 - Fixed skin upload/extract path issues that caused double-nesting when archives contain a top-level folder by using a single-stage extract/source strip.
 - TUI: toggling the 'excluded' state now merges changes with the server-side `excluded_types` value instead of overwriting the whole list; toggling uses substring matching for removal when appropriate (e.g., removing `wifi` will also un-exclude `iwlwifi_1` if keyed by `wifi`).
 - CLI: `get-excluded-types` command returns the current CSV to allow safe merges; `set-excluded-types` remains a full-set setter for explicit changes.
 ### üêõ Bug Fixes

- Fixed several issues around thermal zone selection and invalid temp readings.
- Avoided excessive UI button heights on narrow screens by constraining setting-row buttons in CSS.
- Fixed various parsing & range issues in config parsing and CLI handling.
 - Fixed skin upload/extract path issues that caused double-nesting when archives contain a top-level folder by using a single-stage extract/source strip.
 - Fixed edge cases: `mkstemp` template and handling of base64 payloads larger than statically-sized buffers.

### üîí Security & Stability Improvements

- **Command Injection Prevention:** Replaced unsafe `system()` calls in skin archive extraction with secure `fork()`/`execvp()` pattern to prevent command injection vulnerabilities.
- **Buffer Overflow Protection:** Replaced unsafe string operations (`strcpy`, `strncpy`) with bounds-checked `snprintf()` throughout the codebase.
- **Enhanced Input Validation:** Added comprehensive bounds checking for configuration values (thermal zones, temperatures) and CLI arguments.
- **Improved Error Handling:** Strengthened error handling in file operations, memory allocation, and system calls with proper cleanup.
- **Log Rotation:** Added automatic log file rotation (10MB limit) to prevent disk space exhaustion and improve log management.
- **Performance Optimization:** Implemented CPU frequency path caching to reduce filesystem syscalls during frequency adjustments.
- **Unit Testing:** Added `--test` CLI option with basic unit tests for core functions (`base64_decode`, `clamp`, `read_temp`).
- **API Extensions:** Added `/api/metrics` endpoint providing real-time CPU frequency data for all cores.

### üîß Additional Improvements

### üß≠ Developer / Packaging

- Regenerated embedded asset headers (`include/index_html.h`, `include/main_js.h`, `include/styles_css.h`).
- Updated `cpu_throttle_ctl` to keep in sync with server/socket API changes.
- Updated packaging artifact `burn2cool-linux-x86_64-v3.0.tar.xz` (replaced during iterative work) ‚Äî will be re-tagged/rebuilt for v4.0.

### üîú TODO / Next Steps (for v4.0 finishing)

- Add integration tests for thermal zone detection / avg temp behavior across various systems.
- Add end-user upgrade/migration notes focusing on the `thermal_zone`, `avg_temp`, and `excluded_types` config keys.
- Iterate on UI for shorter labels / icons for smaller screens and add an icon-only control where appropriate.
- Add docs for `cpu_throttle_ctl` runtime control commands for new settings.
 - Consider hardening `system()` calls for extraction/removal into secure `posix_spawn` or `libarchive` flows and add server-side authentication/authorization for API endpoints that modify system-wide files.

- Normalize control socket outputs to a consistent JSON structure for scriptable clients and update the CLI accordingly (future work / follow-up change).

---
### üß± Daemon / CPU handling (detailed)

The `cpu_throttle.c` daemon contains numerous enhancements between v3.0 and v4.0 (beta). These affect sensor selection, temperature aggregation, throttling behavior, JSON endpoints and robustness.

- Version bump and restart handling
  - `DAEMON_VERSION` updated to **4.0**.
  - `should_restart` introduced to support graceful restart flow.

- Thermal zone selection and manual override
  - `--thermal-zone` and `thermal_zone` config allow manual selection of the thermal zone to use.
  - `detect_cpu_thermal_zone()` finds the best CPU thermal zone based on type strings and plausible temperatures and prefers zone 0 if valid.
  - `set_thermal_zone_path()` picks the sensor path for a specified zone.

- Average temperature across CPU zones
  - `--avg-temp` (`avg_temp` config) added to read and use the average temperature across CPU-related thermal zones.
  - Implemented `read_avg_cpu_temp()` which gathers all CPU-related zones (cpu/core/x86/intel/amd/pkg) and returns an average temperature.

- Exclusion of thermal zone types
  - `excluded_types` config & UI allow excluding certain thermal zone types from averaging and reporting.
  - `is_excluded_thermal_type()` parses the configured list and falls back to common defaults like `int3400, int3402,...`.

- Improved JSON API for zones/status
  - `build_zones_json()` returns `zones` JSON including `zone`, `type`, `temp` (or `null` for excluded), `excluded` flag.
  - `build_status_json()` now includes `thermal_zone` and `use_avg_temp` fields.

- Throttling, hysteresis, and smoothing
  - Linear throttling curve scales frequency between `max_freq` and `min_freq` from `temp_max - 30` up to `temp_max` for smoother transitions.
  - `last_throttle_temp` and a hysteresis threshold (default 3¬∞C) prevent frequent oscillation and churning of frequency adjustments.
  - Behavior remains bounded by `safe_min` where configured.

- Config persistence & safety
  - `save_config_file()` added and called across runtime commands ‚Äî this persists changes to `/etc/cpu_throttle.conf`.

  - `POST /api/settings/excluded-types` and `GET` endpoint were added to allow querying and updating the `excluded_types` setting (comma-separated list). The Web UI binds to this for the excluded types setting in the Settings dialog.
    - `POST /api/settings/excluded-types` and `GET` endpoint were added to allow querying and updating the `excluded_types` setting (comma-separated list). The endpoint supports quoted/unquoted string values and intentionally normalizes tokens (trim/lowercase/dedupe); replies include `saved` and `saved_to` fields indicating where the setting was written.
  - Used stricter checks (`fscanf` return checks, explicit null-termination) for robustness with sensor & sysfs reads.

  Notes:
  - High-level bullets under "Improvements (summary)" are intentionally short ‚Äî the detailed section below is the authoritative source for exact behavior and mechanics.
  - If you want a single place to look, use the "Daemon / CPU handling (detailed)" section; otherwise the top-level summaries give a quick overview.

These updates were identified by comparing `cpu_throttle.c` between `origin/main` and `beta` and are included in the v4.0 (beta) branch.

Last update (draft): Compare `origin/main (v3.0)` ‚Üí `beta (v4.x draft)` ‚Äî includes feature additions for thermal detection, avg-temp, UI updates, and throttling improvements.

If you prefer, I can open a PR from `beta` to set this as `RELEASE_NOTES/v4.0.md` and continue iterating there.
