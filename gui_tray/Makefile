CC = gcc
CANDIDATE_APPINDICATOR = $(shell pkg-config --exists libappindicator-3.0 2>/dev/null && echo libappindicator-3.0 || (pkg-config --exists ayatana-appindicator3-0.1 2>/dev/null && echo ayatana-appindicator3-0.1 || echo ""))
ifeq ($(CANDIDATE_APPINDICATOR),)
PKG_APPINDICATOR =
else
PKG_APPINDICATOR = $(CANDIDATE_APPINDICATOR)
endif

ifeq ($(PKG_APPINDICATOR),libappindicator-3.0)
APPINDICATOR_HEADER := \"libappindicator/app-indicator.h\"
else ifeq ($(PKG_APPINDICATOR),ayatana-appindicator3-0.1)
APPINDICATOR_HEADER := \"libayatana-appindicator/app-indicator.h\"
else
APPINDICATOR_HEADER := \"libappindicator/app-indicator.h\" # fallback
endif

PKG_CFLAGS = $(shell pkg-config --cflags gtk+-3.0 $(PKG_APPINDICATOR) libcurl json-c libnotify)
PKG_LIBS = $(shell pkg-config --libs gtk+-3.0 $(PKG_APPINDICATOR) libcurl json-c libnotify)

# If any of the required pkg-config modules are missing, stop with a helpful
# message so users don't have to debug pkg-config themselves.
ifneq ($(strip $(PKG_CFLAGS)),)
	CFLAGS = -O2 -Wall $(PKG_CFLAGS)
else
	$(error Missing development packages. Please install: libgtk-3-dev libcurl4-openssl-dev libjson-c-dev libnotify-dev and either libayatana-appindicator3-dev or libappindicator-dev)
endif

ifneq ($(PKG_APPINDICATOR),)
	# determine header include path for appindicator implementation
	ifeq ($(PKG_APPINDICATOR),libappindicator-3.0)
		APPINDICATOR_INC = <libappindicator/app-indicator.h>
	else ifeq ($(PKG_APPINDICATOR),ayatana-appindicator3-0.1)
		APPINDICATOR_INC = <libayatana-appindicator/app-indicator.h>
	else
		APPINDICATOR_INC = <libappindicator/app-indicator.h>
	endif
else
	APPINDICATOR_INC = <libappindicator/app-indicator.h>
endif

PKG_LIBS = $(shell pkg-config --libs gtk+-3.0 $(PKG_APPINDICATOR) libcurl json-c libnotify)

LDFLAGS = $(PKG_LIBS)

# Generated header file used to include the correct appindicator header
APPIND_HEADER = include/appindicator_include.h

# Ensure the generated header exists before compiling. Also add include/ to
# the compiler search path so sources can use `#include "appindicator_include.h"`.
CFLAGS += -include $(APPIND_HEADER) -Iinclude
LDFLAGS = $(PKG_LIBS)

TARGET = burn2cool_tray
SRCS = src/burn2cool_tray.c src/overview.c

all: $(TARGET)

$(TARGET): $(SRCS)
	# ensure include/ exists
	@mkdir -p include
	# generate include wrapper (overwrites if necessary)
	@echo "// generated by Makefile - do not edit" > $(APPIND_HEADER)
	@echo "#ifndef CPU_THROTTLE_APPINDICATOR_INCLUDE_H" >> $(APPIND_HEADER)
	@echo "#define CPU_THROTTLE_APPINDICATOR_INCLUDE_H" >> $(APPIND_HEADER)
	@echo "#include $(APPINDICATOR_INC)" >> $(APPIND_HEADER)
	@echo "#endif" >> $(APPIND_HEADER)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

clean:
	rm -f $(TARGET)

install: $(TARGET)
	mkdir -p $(DESTDIR)/usr/local/bin
	cp $(TARGET) $(DESTDIR)/usr/local/bin/$(TARGET)

.PHONY: all clean install
